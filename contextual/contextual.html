<!DOCTYPE html>
<html>
  <meta charset="UTF-8">
  <title>Canvas Dabbling</title>

  <div id="canvasContainer">
    <canvas id="diagonal" style="border: 1px solid;"  width="600" height="600"></canvas>
    <svg id="svgEmpty" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width=0 height=0></svg>
  </div>
  <div id="buttons">
    <button id="renderCanvasButton">Render Canvas</button>
    <button id="renderSvgButton">Render SVG</button>
    <button id="svgButton">Download SVG</button>
  </div>
  <script src="contextual.js"></script>
  <script src="test_rule.js"></script>
  <script src="rAF.js"></script>
  <script>

    console.log("Initializing JavaScript stuff!");
    var svgNS = "http://www.w3.org/2000/svg";
    // Populated in onLoad
    var canvas;

    // Set at every mouse click
    var mouseX;
    var mouseY;
    var mouseClicked;

    // Set every frame
    var t;
    var dt; // time delta since last frame

    var canvasRender;
    var svgRender;

    function onLoad() {
      var time, svg;

      canvas = document.getElementById('diagonal');
      canvasRender = new CanvasRenderer(canvas);
      svg = document.getElementById("svgEmpty");
      svg.setAttributeNS(null, "width", 600);
      svg.setAttributeNS(null, "height", 600);
      svgRender = new SvgRenderer(svg);

      // Listeners for mouse: Update mouseX/mouseY only when dragging.
      canvas.addEventListener("mousedown", function() { mouseClicked = true; }, true);
      canvas.addEventListener("mouseup", function() { mouseClicked = false; }, true);
      canvas.addEventListener("mousemove", function(event) {
        if (mouseClicked) {
          mouseX = event.clientX;
          mouseY = event.clientY;
        }
      }, true);

      document.getElementById("renderCanvasButton").onclick = function() {
        console.log("rendering!");
        step();
      };

      document.getElementById("svgButton").onclick = function() {
        updateRenderer(svgRender);
        svgRender.render(t, mouseX, mouseY);

        buttons = document.getElementById('buttons');
        while (buttons.firstChild) {
          buttons.removeChild(buttons.firstChild);
        }
        buttons.appendChild(makeDownload(svg, "file.svg", "Download SVG"));
      };

      mouseX = canvas.width / 2;
      mouseY = canvas.height / 2;
      var time = new Date();
      t0 = time.getTime();

      branchBool = false;

      t = time.getTime();

      resolveRules(triangleRandomRule);
      accumProbability(triangleRandomRule);
    }

    function step() {
      var time = new Date();

      dt = (time.getTime() - t) / 1000;
      t = time.getTime();
     
      canvasRender.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
      canvasRender.drawRule(triangleRandomRule.startRuleRef);

      //window.requestAnimFrame(step);
    }

    window.addEventListener("load", onLoad, true);
  </script>
  <body>
  </body>
</html>
